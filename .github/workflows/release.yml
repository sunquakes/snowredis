name: Create Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag
        id: tag
        run: echo "tag=${GITHUB_REF#refs/*/}" >> $GITHUB_OUTPUT

      - name: Extract changelog
        id: changelog
        run: |
          # Extract the changelog for the specific version
          # Find the start of the current version section
          START_LINE=$(grep -n "^## \[${{ steps.tag.outputs.tag }}\]" CHANGELOG.md | cut -d: -f1)
          if [ -z "$START_LINE" ]; then
            # If exact version not found, try to find the version without 'v' prefix
            TAG_NAME="${{ steps.tag.outputs.tag }}"
            if [[ $TAG_NAME == v* ]]; then
              CLEAN_TAG="${TAG_NAME#v}"
              START_LINE=$(grep -n "^## \[$CLEAN_TAG\]" CHANGELOG.md | cut -d: -f1)
            fi
          fi
          
          if [ -z "$START_LINE" ]; then
            echo "Error: Version ${{ steps.tag.outputs.tag }} not found in CHANGELOG.md" >&2
            exit 1
          fi
          
          # Find the start of the next version section
          NEXT_HEADER=$(tail -n +$((START_LINE + 1)) CHANGELOG.md | grep -n "^## \[" | head -n1 | cut -d: -f1)
          
          if [ -n "$NEXT_HEADER" ]; then
            # If there's a next version, extract up to that line (exclusive)
            # Adjust calculation to correctly include content up to but not including the next version header
            END_LINE=$((START_LINE + NEXT_HEADER - 2))
            sed -n "$((START_LINE + 1)),$((END_LINE))p" CHANGELOG.md > release_notes.txt
          else
            # If no next version, extract to the end of file
            TOTAL_LINES=$(wc -l < CHANGELOG.md)
            sed -n "$((START_LINE + 1)),$((TOTAL_LINES))p" CHANGELOG.md > release_notes.txt
          fi
          
          # Read the content for release notes, making sure all sections are included
          RELEASE_NOTES=$(cat release_notes.txt)
          
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: ${{ env.RELEASE_NOTES }}
          draft: false
          prerelease: false